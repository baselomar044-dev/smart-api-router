'use client'

import { useState, useRef, useEffect } from 'react'
import { 
  Bot, Plus, Settings, Trash2, Play, Square, MessageSquare,
  Brain, Zap, Database, Key, Upload, Download, Copy, Check,
  ChevronRight, Sparkles, History, RotateCcw, Save, Edit3,
  Globe, Code, FileText, Image, Mail, Clock, Target, Cpu
} from 'lucide-react'

interface Agent {
  id: string
  name: string
  description: string
  avatar: string
  model: string
  apiKeyId: string
  systemPrompt: string
  temperature: number
  maxTokens: number
  memory: boolean
  memoryLimit: number
  createdAt: Date
  lastUsed?: Date
  totalMessages: number
  status: 'idle' | 'running' | 'error'
  capabilities: string[]
}

interface Conversation {
  id: string
  agentId: string
  messages: { role: 'user' | 'assistant'; content: string; timestamp: Date }[]
  createdAt: Date
}

interface ApiKey {
  id: string
  name: string
  provider: string
}

const AGENT_TEMPLATES = [
  {
    name: 'Ù…Ø³Ø§Ø¹Ø¯ Ø¹Ø§Ù…',
    nameEn: 'General Assistant',
    description: 'Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
    descriptionEn: 'Smart assistant for daily tasks',
    avatar: 'ğŸ¤–',
    systemPrompt: 'You are a helpful, friendly assistant. Be concise and accurate.',
    capabilities: ['chat', 'analysis', 'writing']
  },
  {
    name: 'Ù…Ø¨Ø±Ù…Ø¬ Ø®Ø¨ÙŠØ±',
    nameEn: 'Expert Coder',
    description: 'Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„ÙƒÙˆØ¯',
    descriptionEn: 'Specialized in programming and code',
    avatar: 'ğŸ‘¨â€ğŸ’»',
    systemPrompt: 'You are an expert programmer. Write clean, efficient, well-documented code. Explain your solutions clearly.',
    capabilities: ['coding', 'debugging', 'review']
  },
  {
    name: 'ÙƒØ§ØªØ¨ Ù…Ø­ØªÙˆÙ‰',
    nameEn: 'Content Writer',
    description: 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ',
    descriptionEn: 'Create creative and professional content',
    avatar: 'âœï¸',
    systemPrompt: 'You are a professional content writer. Create engaging, well-structured content tailored to the audience.',
    capabilities: ['writing', 'editing', 'seo']
  },
  {
    name: 'Ù…Ø­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª',
    nameEn: 'Data Analyst',
    description: 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø¤Ù‰',
    descriptionEn: 'Analyze data and extract insights',
    avatar: 'ğŸ“Š',
    systemPrompt: 'You are a data analyst. Analyze data thoroughly, identify patterns, and provide actionable insights.',
    capabilities: ['analysis', 'visualization', 'reporting']
  },
  {
    name: 'Ù…ØªØ±Ø¬Ù… Ù…Ø­ØªØ±Ù',
    nameEn: 'Professional Translator',
    description: 'ØªØ±Ø¬Ù…Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ù„ØºØ§Øª',
    descriptionEn: 'Accurate translation between languages',
    avatar: 'ğŸŒ',
    systemPrompt: 'You are a professional translator. Provide accurate, natural translations that preserve meaning and tone.',
    capabilities: ['translation', 'localization']
  },
  {
    name: 'Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø­Ø«ÙŠ',
    nameEn: 'Research Assistant',
    description: 'Ø§Ù„Ø¨Ø­Ø« ÙˆØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
    descriptionEn: 'Research and summarize information',
    avatar: 'ğŸ”¬',
    systemPrompt: 'You are a research assistant. Conduct thorough research, cite sources, and provide comprehensive summaries.',
    capabilities: ['research', 'summarization', 'citations']
  }
]

const AVATAR_OPTIONS = ['ğŸ¤–', 'ğŸ‘¨â€ğŸ’»', 'âœï¸', 'ğŸ“Š', 'ğŸŒ', 'ğŸ”¬', 'ğŸ¨', 'ğŸ“§', 'ğŸ§ ', 'âš¡', 'ğŸ¯', 'ğŸ’¡']

const MODELS = [
  { id: 'gpt-4o', name: 'GPT-4o', provider: 'OpenAI', quality: 'Excellent' },
  { id: 'gpt-4o-mini', name: 'GPT-4o Mini', provider: 'OpenAI', quality: 'Good' },
  { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', provider: 'Anthropic', quality: 'Excellent' },
  { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', provider: 'Google', quality: 'Excellent' },
  { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash', provider: 'Google', quality: 'Good' },
  { id: 'deepseek-chat', name: 'DeepSeek Chat', provider: 'DeepSeek', quality: 'Good' },
]

export default function Agents() {
  const [agents, setAgents] = useState<Agent[]>([])
  const [selectedAgent, setSelectedAgent] = useState<Agent | null>(null)
  const [conversations, setConversations] = useState<Conversation[]>([])
  const [currentConversation, setCurrentConversation] = useState<Conversation | null>(null)
  const [showCreateModal, setShowCreateModal] = useState(false)
  const [showSettingsModal, setShowSettingsModal] = useState(false)
  const [view, setView] = useState<'list' | 'chat' | 'settings'>('list')
  const [message, setMessage] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [apiKeys, setApiKeys] = useState<ApiKey[]>([])
  const [copiedId, setCopiedId] = useState<string | null>(null)
  const chatEndRef = useRef<HTMLDivElement>(null)
  
  // New agent form
  const [newAgent, setNewAgent] = useState({
    name: '',
    description: '',
    avatar: 'ğŸ¤–',
    model: 'gpt-4o-mini',
    apiKeyId: '',
    systemPrompt: '',
    temperature: 0.7,
    maxTokens: 2048,
    memory: true,
    memoryLimit: 10,
    capabilities: [] as string[]
  })

  // Load agents and API keys from localStorage
  useEffect(() => {
    const savedAgents = localStorage.getItem('solveit_agents')
    if (savedAgents) {
      setAgents(JSON.parse(savedAgents))
    }
    
    const savedConversations = localStorage.getItem('solveit_agent_conversations')
    if (savedConversations) {
      setConversations(JSON.parse(savedConversations))
    }

    // Load API keys
    const keys: ApiKey[] = []
    const providers = ['openai', 'anthropic', 'google', 'deepseek', 'groq']
    providers.forEach(provider => {
      const key = localStorage.getItem(`${provider}_api_key`)
      if (key) {
        keys.push({ id: provider, name: provider.charAt(0).toUpperCase() + provider.slice(1), provider })
      }
    })
    setApiKeys(keys)
  }, [])

  // Save agents to localStorage
  useEffect(() => {
    if (agents.length > 0) {
      localStorage.setItem('solveit_agents', JSON.stringify(agents))
    }
  }, [agents])

  // Save conversations
  useEffect(() => {
    if (conversations.length > 0) {
      localStorage.setItem('solveit_agent_conversations', JSON.stringify(conversations))
    }
  }, [conversations])

  // Scroll to bottom of chat
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [currentConversation?.messages])

  const createAgent = () => {
    if (!newAgent.name || !newAgent.systemPrompt) return

    const agent: Agent = {
      id: `agent_${Date.now()}`,
      name: newAgent.name,
      description: newAgent.description,
      avatar: newAgent.avatar,
      model: newAgent.model,
      apiKeyId: newAgent.apiKeyId,
      systemPrompt: newAgent.systemPrompt,
      temperature: newAgent.temperature,
      maxTokens: newAgent.maxTokens,
      memory: newAgent.memory,
      memoryLimit: newAgent.memoryLimit,
      createdAt: new Date(),
      totalMessages: 0,
      status: 'idle',
      capabilities: newAgent.capabilities
    }

    setAgents([...agents, agent])
    setShowCreateModal(false)
    resetNewAgentForm()
  }

  const resetNewAgentForm = () => {
    setNewAgent({
      name: '',
      description: '',
      avatar: 'ğŸ¤–',
      model: 'gpt-4o-mini',
      apiKeyId: '',
      systemPrompt: '',
      temperature: 0.7,
      maxTokens: 2048,
      memory: true,
      memoryLimit: 10,
      capabilities: []
    })
  }

  const applyTemplate = (template: typeof AGENT_TEMPLATES[0]) => {
    setNewAgent({
      ...newAgent,
      name: template.nameEn,
      description: template.descriptionEn,
      avatar: template.avatar,
      systemPrompt: template.systemPrompt,
      capabilities: template.capabilities
    })
  }

  const startChat = (agent: Agent) => {
    setSelectedAgent(agent)
    
    // Find or create conversation
    let conv = conversations.find(c => c.agentId === agent.id)
    if (!conv) {
      conv = {
        id: `conv_${Date.now()}`,
        agentId: agent.id,
        messages: [],
        createdAt: new Date()
      }
      setConversations([...conversations, conv])
    }
    setCurrentConversation(conv)
    setView('chat')
  }

  // Tool execution for agents
  const executeTool = async (tool: string, params: any) => {
    try {
      const storedKeys = localStorage.getItem('solveit_api_keys')
      const apiKeys = storedKeys ? JSON.parse(storedKeys) : {}
      
      const response = await fetch('/api/agent/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tool, params, apiKeys })
      })
      
      return await response.json()
    } catch (error: any) {
      return { success: false, error: error.message }
    }
  }

  // Parse tool calls from AI response
  const parseToolCalls = (content: string): { tool: string; params: any }[] => {
    const toolPattern = /\[TOOL:(\w+)\]\s*```json\s*([\s\S]*?)```/g
    const calls: { tool: string; params: any }[] = []
    let match
    
    while ((match = toolPattern.exec(content)) !== null) {
      try {
        calls.push({
          tool: match[1],
          params: JSON.parse(match[2])
        })
      } catch (e) {
        // Invalid JSON, skip
      }
    }
    return calls
  }

  const sendMessage = async () => {
    if (!message.trim() || !selectedAgent || !currentConversation || isLoading) return

    const userMessage = { role: 'user' as const, content: message, timestamp: new Date() }
    
    // Update conversation with user message
    const updatedConv = {
      ...currentConversation,
      messages: [...currentConversation.messages, userMessage]
    }
    setCurrentConversation(updatedConv)
    setConversations(conversations.map(c => c.id === updatedConv.id ? updatedConv : c))
    setMessage('')
    setIsLoading(true)

    // Update agent status
    setAgents(agents.map(a => a.id === selectedAgent.id ? { ...a, status: 'running' as const } : a))

    try {
      // Enhanced system prompt with tool capabilities
      const toolsPrompt = `
You have access to these tools. To use a tool, respond with [TOOL:tool_name] followed by JSON parameters in code block:

Available tools:
- web_search: Search the web. Params: { "query": "search terms" }
- code_execute: Run JavaScript code. Params: { "code": "your code", "language": "javascript" }
- api_call: Make HTTP requests. Params: { "url": "...", "method": "GET|POST", "body": {} }
- database_query: Query Supabase. Params: { "table": "...", "operation": "select|insert|update|delete", "query": "..." }
- ai_reason: Additional AI reasoning. Params: { "prompt": "..." }

Example tool usage:
[TOOL:web_search]
\`\`\`json
{ "query": "latest news about AI" }
\`\`\`

After using a tool, explain the results to the user.
`

      // Build messages for API
      const apiMessages = [
        { role: 'system', content: selectedAgent.systemPrompt + '\n\n' + toolsPrompt }
      ]

      // Add memory (last N messages)
      if (selectedAgent.memory) {
        const memoryMessages = updatedConv.messages.slice(-selectedAgent.memoryLimit * 2)
        memoryMessages.forEach(m => {
          apiMessages.push({ role: m.role, content: m.content })
        })
      } else {
        apiMessages.push({ role: 'user', content: message })
      }

      const response = await fetch('/api/ai/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: apiMessages,
          model: selectedAgent.model,
          temperature: selectedAgent.temperature,
          max_tokens: selectedAgent.maxTokens
        })
      })

      if (!response.ok) throw new Error('Failed to get response')

      const data = await response.json()
      let content = data.content || data.message || 'No response'

      // Check for tool calls and execute them
      const toolCalls = parseToolCalls(content)
      if (toolCalls.length > 0) {
        const toolResults: string[] = []
        
        for (const call of toolCalls) {
          const result = await executeTool(call.tool, call.params)
          toolResults.push(`\nğŸ“Š **${call.tool} result:**\n\`\`\`json\n${JSON.stringify(result, null, 2)}\n\`\`\``)
        }
        
        // Append tool results to content
        content = content + '\n\n---\n**Tool Execution Results:**' + toolResults.join('\n')
      }

      const assistantMessage = { 
        role: 'assistant' as const, 
        content, 
        timestamp: new Date() 
      }

      // Update conversation with assistant message
      const finalConv = {
        ...updatedConv,
        messages: [...updatedConv.messages, assistantMessage]
      }
      setCurrentConversation(finalConv)
      setConversations(conversations.map(c => c.id === finalConv.id ? finalConv : c))

      // Update agent stats
      setAgents(agents.map(a => a.id === selectedAgent.id ? { 
        ...a, 
        status: 'idle' as const,
        lastUsed: new Date(),
        totalMessages: a.totalMessages + 2
      } : a))

    } catch (error) {
      console.error('Error:', error)
      setAgents(agents.map(a => a.id === selectedAgent.id ? { ...a, status: 'error' as const } : a))
    } finally {
      setIsLoading(false)
    }
  }

  const deleteAgent = (agentId: string) => {
    setAgents(agents.filter(a => a.id !== agentId))
    setConversations(conversations.filter(c => c.agentId !== agentId))
    if (selectedAgent?.id === agentId) {
      setSelectedAgent(null)
      setCurrentConversation(null)
      setView('list')
    }
  }

  const clearConversation = () => {
    if (!currentConversation) return
    const clearedConv = { ...currentConversation, messages: [] }
    setCurrentConversation(clearedConv)
    setConversations(conversations.map(c => c.id === clearedConv.id ? clearedConv : c))
  }

  const exportAgent = (agent: Agent) => {
    const data = {
      agent,
      conversations: conversations.filter(c => c.agentId === agent.id)
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `agent_${agent.name.replace(/\s+/g, '_')}.json`
    a.click()
    URL.revokeObjectURL(url)
  }

  const copyAgentId = (id: string) => {
    navigator.clipboard.writeText(id)
    setCopiedId(id)
    setTimeout(() => setCopiedId(null), 2000)
  }

  return (
    <div className="h-full flex flex-col">
      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b border-zinc-800">
        <div className="flex items-center gap-3">
          {view !== 'list' && (
            <button
              onClick={() => setView('list')}
              className="p-2 hover:bg-zinc-800 rounded-lg transition-colors"
            >
              <ChevronRight className="w-5 h-5 rotate-180" />
            </button>
          )}
          <Bot className="w-6 h-6 text-violet-400" />
          <h1 className="text-xl font-semibold">
            {view === 'list' ? 'AI Agents' : view === 'chat' ? selectedAgent?.name : 'Agent Settings'}
          </h1>
        </div>
        
        {view === 'list' && (
          <button
            onClick={() => setShowCreateModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg transition-colors"
          >
            <Plus className="w-4 h-4" />
            <span>Create Agent</span>
          </button>
        )}

        {view === 'chat' && selectedAgent && (
          <div className="flex items-center gap-2">
            <button
              onClick={clearConversation}
              className="p-2 hover:bg-zinc-800 rounded-lg transition-colors"
              title="Clear conversation"
            >
              <RotateCcw className="w-5 h-5" />
            </button>
            <button
              onClick={() => exportAgent(selectedAgent)}
              className="p-2 hover:bg-zinc-800 rounded-lg transition-colors"
              title="Export agent"
            >
              <Download className="w-5 h-5" />
            </button>
            <button
              onClick={() => setView('settings')}
              className="p-2 hover:bg-zinc-800 rounded-lg transition-colors"
              title="Agent settings"
            >
              <Settings className="w-5 h-5" />
            </button>
          </div>
        )}
      </div>

      {/* Agent List View */}
      {view === 'list' && (
        <div className="flex-1 overflow-auto p-4">
          {agents.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-full text-center">
              <div className="w-20 h-20 bg-zinc-800 rounded-full flex items-center justify-center mb-4">
                <Bot className="w-10 h-10 text-zinc-600" />
              </div>
              <h3 className="text-lg font-medium mb-2">No Agents Yet</h3>
              <p className="text-zinc-400 mb-6 max-w-md">
                Create your first AI agent with custom personality, memory, and capabilities.
              </p>
              <button
                onClick={() => setShowCreateModal(true)}
                className="flex items-center gap-2 px-6 py-3 bg-violet-600 hover:bg-violet-500 rounded-lg transition-colors"
              >
                <Plus className="w-5 h-5" />
                <span>Create Your First Agent</span>
              </button>
            </div>
          ) : (
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
              {agents.map(agent => (
                <div
                  key={agent.id}
                  className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 hover:border-violet-500/50 transition-all group"
                >
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className="text-3xl">{agent.avatar}</div>
                      <div>
                        <h3 className="font-semibold">{agent.name}</h3>
                        <p className="text-xs text-zinc-500">{agent.model}</p>
                      </div>
                    </div>
                    <div className={`w-2 h-2 rounded-full ${
                      agent.status === 'running' ? 'bg-green-500 animate-pulse' :
                      agent.status === 'error' ? 'bg-red-500' : 'bg-zinc-600'
                    }`} />
                  </div>

                  <p className="text-sm text-zinc-400 mb-3 line-clamp-2">
                    {agent.description || agent.systemPrompt.slice(0, 100)}...
                  </p>

                  <div className="flex items-center gap-2 mb-3 flex-wrap">
                    {agent.memory && (
                      <span className="px-2 py-0.5 bg-violet-500/20 text-violet-400 text-xs rounded-full flex items-center gap-1">
                        <Brain className="w-3 h-3" /> Memory
                      </span>
                    )}
                    {agent.capabilities.slice(0, 2).map(cap => (
                      <span key={cap} className="px-2 py-0.5 bg-zinc-800 text-zinc-400 text-xs rounded-full">
                        {cap}
                      </span>
                    ))}
                  </div>

                  <div className="flex items-center justify-between text-xs text-zinc-500 mb-3">
                    <span>{agent.totalMessages} messages</span>
                    {agent.lastUsed && (
                      <span>Last used: {new Date(agent.lastUsed).toLocaleDateString()}</span>
                    )}
                  </div>

                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => startChat(agent)}
                      className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg transition-colors"
                    >
                      <MessageSquare className="w-4 h-4" />
                      <span>Chat</span>
                    </button>
                    <button
                      onClick={() => copyAgentId(agent.id)}
                      className="p-2 hover:bg-zinc-800 rounded-lg transition-colors"
                      title="Copy Agent ID"
                    >
                      {copiedId === agent.id ? <Check className="w-4 h-4 text-green-500" /> : <Copy className="w-4 h-4" />}
                    </button>
                    <button
                      onClick={() => deleteAgent(agent.id)}
                      className="p-2 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors"
                      title="Delete agent"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Chat View */}
      {view === 'chat' && selectedAgent && currentConversation && (
        <div className="flex-1 flex flex-col overflow-hidden">
          {/* Messages */}
          <div className="flex-1 overflow-auto p-4 space-y-4">
            {currentConversation.messages.length === 0 && (
              <div className="flex flex-col items-center justify-center h-full text-center">
                <div className="text-5xl mb-4">{selectedAgent.avatar}</div>
                <h3 className="text-lg font-medium mb-2">Start chatting with {selectedAgent.name}</h3>
                <p className="text-zinc-400 text-sm max-w-md">
                  {selectedAgent.description || selectedAgent.systemPrompt.slice(0, 150)}
                </p>
              </div>
            )}

            {currentConversation.messages.map((msg, idx) => (
              <div
                key={idx}
                className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div className={`max-w-[80%] rounded-2xl px-4 py-3 ${
                  msg.role === 'user'
                    ? 'bg-violet-600 text-white'
                    : 'bg-zinc-800 text-zinc-100'
                }`}>
                  {msg.role === 'assistant' && (
                    <div className="flex items-center gap-2 mb-2 text-xs text-zinc-400">
                      <span>{selectedAgent.avatar}</span>
                      <span>{selectedAgent.name}</span>
                    </div>
                  )}
                  <p className="whitespace-pre-wrap">{msg.content}</p>
                </div>
              </div>
            ))}

            {isLoading && (
              <div className="flex justify-start">
                <div className="bg-zinc-800 rounded-2xl px-4 py-3">
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-violet-500 rounded-full animate-bounce" />
                    <div className="w-2 h-2 bg-violet-500 rounded-full animate-bounce delay-100" />
                    <div className="w-2 h-2 bg-violet-500 rounded-full animate-bounce delay-200" />
                  </div>
                </div>
              </div>
            )}

            <div ref={chatEndRef} />
          </div>

          {/* Input */}
          <div className="p-4 border-t border-zinc-800">
            <div className="flex items-center gap-3">
              <input
                type="text"
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && sendMessage()}
                placeholder="Type your message..."
                className="flex-1 bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 focus:outline-none focus:border-violet-500"
                disabled={isLoading}
              />
              <button
                onClick={sendMessage}
                disabled={!message.trim() || isLoading}
                className="p-3 bg-violet-600 hover:bg-violet-500 disabled:bg-zinc-700 disabled:cursor-not-allowed rounded-xl transition-colors"
              >
                <Zap className="w-5 h-5" />
              </button>
            </div>
            
            {selectedAgent.memory && (
              <p className="text-xs text-zinc-500 mt-2 flex items-center gap-1">
                <Brain className="w-3 h-3" />
                Memory: Last {selectedAgent.memoryLimit} exchanges
              </p>
            )}
          </div>
        </div>
      )}

      {/* Create Agent Modal */}
      {showCreateModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto">
            <div className="p-4 border-b border-zinc-800 flex items-center justify-between">
              <h2 className="text-lg font-semibold flex items-center gap-2">
                <Sparkles className="w-5 h-5 text-violet-400" />
                Create New Agent
              </h2>
              <button
                onClick={() => { setShowCreateModal(false); resetNewAgentForm() }}
                className="p-2 hover:bg-zinc-800 rounded-lg transition-colors"
              >
                âœ•
              </button>
            </div>

            <div className="p-4 space-y-4">
              {/* Templates */}
              <div>
                <label className="block text-sm font-medium mb-2">Quick Templates</label>
                <div className="grid grid-cols-3 gap-2">
                  {AGENT_TEMPLATES.map(template => (
                    <button
                      key={template.nameEn}
                      onClick={() => applyTemplate(template)}
                      className="p-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-left transition-colors"
                    >
                      <div className="text-2xl mb-1">{template.avatar}</div>
                      <div className="text-sm font-medium">{template.nameEn}</div>
                      <div className="text-xs text-zinc-500">{template.descriptionEn}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Basic Info */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2">Name</label>
                  <input
                    type="text"
                    value={newAgent.name}
                    onChange={(e) => setNewAgent({ ...newAgent, name: e.target.value })}
                    placeholder="Agent name"
                    className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 focus:outline-none focus:border-violet-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Avatar</label>
                  <div className="flex gap-1 flex-wrap">
                    {AVATAR_OPTIONS.map(avatar => (
                      <button
                        key={avatar}
                        onClick={() => setNewAgent({ ...newAgent, avatar })}
                        className={`w-9 h-9 rounded-lg text-xl flex items-center justify-center transition-colors ${
                          newAgent.avatar === avatar ? 'bg-violet-600' : 'bg-zinc-800 hover:bg-zinc-700'
                        }`}
                      >
                        {avatar}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Description</label>
                <input
                  type="text"
                  value={newAgent.description}
                  onChange={(e) => setNewAgent({ ...newAgent, description: e.target.value })}
                  placeholder="Brief description"
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 focus:outline-none focus:border-violet-500"
                />
              </div>

              {/* Model & API Key */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2">Model</label>
                  <select
                    value={newAgent.model}
                    onChange={(e) => setNewAgent({ ...newAgent, model: e.target.value })}
                    className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 focus:outline-none focus:border-violet-500"
                  >
                    {MODELS.map(model => (
                      <option key={model.id} value={model.id}>
                        {model.name} ({model.provider})
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">API Key</label>
                  <select
                    value={newAgent.apiKeyId}
                    onChange={(e) => setNewAgent({ ...newAgent, apiKeyId: e.target.value })}
                    className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 focus:outline-none focus:border-violet-500"
                  >
                    <option value="">Auto-detect</option>
                    {apiKeys.map(key => (
                      <option key={key.id} value={key.id}>{key.name}</option>
                    ))}
                  </select>
                </div>
              </div>

              {/* System Prompt */}
              <div>
                <label className="block text-sm font-medium mb-2">System Prompt</label>
                <textarea
                  value={newAgent.systemPrompt}
                  onChange={(e) => setNewAgent({ ...newAgent, systemPrompt: e.target.value })}
                  placeholder="Define the agent's personality and behavior..."
                  rows={4}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 focus:outline-none focus:border-violet-500 resize-none"
                />
              </div>

              {/* Advanced Settings */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Temperature: {newAgent.temperature}
                  </label>
                  <input
                    type="range"
                    min="0"
                    max="1"
                    step="0.1"
                    value={newAgent.temperature}
                    onChange={(e) => setNewAgent({ ...newAgent, temperature: parseFloat(e.target.value) })}
                    className="w-full"
                  />
                  <div className="flex justify-between text-xs text-zinc-500">
                    <span>Precise</span>
                    <span>Creative</span>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Max Tokens: {newAgent.maxTokens}
                  </label>
                  <input
                    type="range"
                    min="256"
                    max="4096"
                    step="256"
                    value={newAgent.maxTokens}
                    onChange={(e) => setNewAgent({ ...newAgent, maxTokens: parseInt(e.target.value) })}
                    className="w-full"
                  />
                </div>
              </div>

              {/* Memory */}
              <div className="flex items-center justify-between p-3 bg-zinc-800 rounded-lg">
                <div className="flex items-center gap-3">
                  <Brain className="w-5 h-5 text-violet-400" />
                  <div>
                    <div className="font-medium">Memory</div>
                    <div className="text-sm text-zinc-400">Remember conversation context</div>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  {newAgent.memory && (
                    <input
                      type="number"
                      value={newAgent.memoryLimit}
                      onChange={(e) => setNewAgent({ ...newAgent, memoryLimit: parseInt(e.target.value) || 10 })}
                      min="1"
                      max="50"
                      className="w-16 bg-zinc-700 border border-zinc-600 rounded px-2 py-1 text-sm"
                    />
                  )}
                  <button
                    onClick={() => setNewAgent({ ...newAgent, memory: !newAgent.memory })}
                    className={`w-12 h-6 rounded-full transition-colors ${
                      newAgent.memory ? 'bg-violet-600' : 'bg-zinc-600'
                    }`}
                  >
                    <div className={`w-5 h-5 bg-white rounded-full transition-transform ${
                      newAgent.memory ? 'translate-x-6' : 'translate-x-0.5'
                    }`} />
                  </button>
                </div>
              </div>
            </div>

            <div className="p-4 border-t border-zinc-800 flex justify-end gap-3">
              <button
                onClick={() => { setShowCreateModal(false); resetNewAgentForm() }}
                className="px-4 py-2 hover:bg-zinc-800 rounded-lg transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={createAgent}
                disabled={!newAgent.name || !newAgent.systemPrompt}
                className="px-4 py-2 bg-violet-600 hover:bg-violet-500 disabled:bg-zinc-700 disabled:cursor-not-allowed rounded-lg transition-colors"
              >
                Create Agent
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
