'use client';

import { useState, useCallback } from 'react';
import LivePreview from '../LivePreview';
import { useAppStore } from '@/lib/store';

export default function LiveEditor() {
  const { apiKeys } = useAppStore();
  const [isFixing, setIsFixing] = useState(false);

  const handleAIFix = useCallback(async (code: string, error: string, language: string): Promise<string> => {
    setIsFixing(true);
    
    try {
      const providers = ['groq', 'gemini', 'deepseek', 'openai', 'anthropic'] as const;
      let activeKey = '';
      let activeProvider = '';
      
      for (const provider of providers) {
        if (apiKeys[provider]) {
          activeKey = apiKeys[provider];
          activeProvider = provider;
          break;
        }
      }

      if (!activeKey) {
        console.warn('No API key available');
        return code;
      }

      const response = await fetch('/api/ai/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: [
            { role: 'system', content: `Fix the error in the ${language} code. Return ONLY the fixed code.` },
            { role: 'user', content: `Error: "${error}"\n\nCode:\n${code}\n\nReturn only fixed code.` },
          ],
          provider: activeProvider,
          apiKey: activeKey,
        }),
      });

      if (!response.ok) throw new Error('AI fix failed');

      const data = await response.json();
      let fixed = data.content || data.message || code;
      fixed = fixed.replace(/^```[\w]*\n?/gm, '').replace(/\n?```$/gm, '').trim();
      return fixed;
    } catch (e) {
      console.error('AI fix error:', e);
      return code;
    } finally {
      setIsFixing(false);
    }
  }, [apiKeys]);

  return (
    <div className="h-full flex flex-col">
      <div className="px-6 py-4 border-b border-gray-700 bg-gray-800/50">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-white flex items-center gap-2">
              âš¡ Live Editor
              {isFixing && (
                <span className="text-sm font-normal text-purple-400 flex items-center gap-1">
                  <span className="w-3 h-3 border-2 border-purple-400 border-t-transparent rounded-full animate-spin" />
                  AI fixing...
                </span>
              )}
            </h1>
            <p className="text-gray-400 text-sm mt-1">Write code and see results instantly â€¢ Lightweight & Fast</p>
          </div>
          <div className="flex items-center gap-2">
            <span className="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-medium">ðŸª¶ Lightweight</span>
            <span className="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs font-medium">~50MB RAM</span>
          </div>
        </div>
      </div>
      <div className="flex-1 overflow-hidden">
        <LivePreview onAIFix={handleAIFix} initialTemplate="blank" />
      </div>
    </div>
  );
}
